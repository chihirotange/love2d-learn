name: Build and deploy to Itch.io

on:
  push:
    branches: [master]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up zip
      run: |
        curl -L --output love.zip https://github.com/love2d/love/releases/download/11.5/love-11.5-win64.zip
        7z x love.zip

    - name: Create .love file
      shell: cmd
      run: |
        dir /s /b
        7z a -tzip mygame.love . -xr!.git -xr!.github -xr!love-11.5-win64 -xr!*.zip

    - name: Create readme
      shell: cmd
      run: |
        echo # How to Run > README.txt
        echo. >> README.txt
        echo This game is built with LOVE2D (https://love2d.org/), an open-source game framework. >> README.txt
        echo. >> README.txt
        echo ## Windows Defender Warning >> README.txt
        echo When running the game, Windows Defender might show a warning because the executable is not signed. >> README.txt
        echo This is normal for small indie games. To run the game: >> README.txt
        echo 1. Click "More info" in the Windows Defender popup >> README.txt
        echo 2. Click "Run anyway" >> README.txt
        echo. >> README.txt
        echo The game is safe to run - you can verify this by checking that it's built with LOVE2D framework. >> README.txt

    - name: Create Windows executable
      shell: cmd
      run: |
        mkdir game-dist
        copy /b love-11.5-win64\love.exe+mygame.love game-dist\mygame.exe
        xcopy love-11.5-win64\*.dll game-dist\
        copy README.txt game-dist\
        copy license.txt game-dist\
        del love-11.5-win64\love.exe
        del love-11.5-win64\lovec.exe
        cd game-dist
        7z a -tzip ..\mygame-windows.zip *

    - name: Upload Windows artifact
      uses: actions/upload-artifact@v4
      with:
        name: mygame-windows
        path: mygame-windows.zip

    - name: Download Butler
      run: |
        powershell -Command "Invoke-WebRequest https://broth.itch.ovh/butler/windows-amd64/LATEST/archive/default -OutFile butler.zip"
        7z x butler.zip -o.\\butler
        .\\butler\\butler.exe version

    - name: Push to itch.io
      env:
        BUTLER_API_KEY: ${{ secrets.BUTLER_API_KEY }}
      run: |
        .\\butler\\butler.exe push game-dist YOUR_ITCH_USERNAME/YOUR_GAME_NAME:windows
        # Replace YOUR_ITCH_USERNAME with your itch.io username
        # Replace YOUR_GAME_NAME with your game's name on itch.io